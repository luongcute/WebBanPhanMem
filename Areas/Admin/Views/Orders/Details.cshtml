@model WebBanPhanMem.Models.Order

@{
    ViewData["Title"] = "Chi tiết Đơn hàng #" + Model.Id;
    var totalAmount = Model.Items?.Sum(i => i.Price * i.Quantity) ?? 0;
}

<div class="container mt-4">
    <h2 class="mb-4 text-info fw-bold">
        <i class="bi bi-file-text"></i> Chi tiết Đơn hàng #@Model.Id
    </h2>

    @* ==================== NÚT XÁC NHẬN THANH TOÁN ==================== *@
    <div class="mb-4">
        @if (Model.PaymentStatus?.ToLower() == "pending")
        {
            <form asp-action="MarkAsPaid" asp-route-id="@Model.Id" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-success btn-lg shadow-sm"
                                    onclick="return confirm('Xác nhận đã nhận tiền và GÁN KEY tự động cho đơn hàng #@Model.Id?');">
                    <i class="bi bi-currency-dollar"></i> Xác nhận Đã Thanh toán
                </button>
            </form>
            <span class="badge bg-warning text-dark fs-5 p-2 ms-3">Trạng thái: Đang chờ</span>
        }
        else if (Model.PaymentStatus?.ToLower() == "paid")
        {
            <span class="badge bg-success fs-5 p-2">
                <i class="bi bi-check-circle"></i> Đơn hàng đã được thanh toán
            </span>
        }
        else
        {
            <span class="badge bg-danger fs-5 p-2">
                <i class="bi bi-x-circle"></i> Trạng thái: @Model.PaymentStatus
            </span>
        }

        @* ==================== NÚT GỬI LẠI KEY EMAIL (ĐÃ THÊM) ==================== *@
        @if (Model.PaymentStatus?.ToLower() == "paid" && Model.LicenseKeys != null && Model.LicenseKeys.Any())
        {
            <form asp-action="ResendLicenseKey" asp-route-id="@Model.Id" method="post" class="d-inline ms-3">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary btn-lg shadow-sm"
                        onclick="return confirm('Xác nhận GỬI LẠI Email Key Bản quyền cho khách hàng @(Model.CustomerEmail ?? Model.ApplicationUser?.Email)?');">
                    <i class="bi bi-envelope-open"></i> Gửi lại Email Key
                </button>
            </form>
        }
        @* ==================== KẾT THÚC NÚT GỬI LẠI KEY ==================== *@
    </div>
    @* ==================== KẾT THÚC NÚT XÁC NHẬN ==================== *@

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white fw-bold">
            Thông tin chung
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Mã đơn hàng</dt>
                <dd class="col-sm-9">#@Model.Id</dd>

                <dt class="col-sm-3">Ngày đặt hàng</dt>
                <dd class="col-sm-9">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</dd>

                <dt class="col-sm-3">Ngày thanh toán</dt>
                <dd class="col-sm-9">
                    @(Model.PaymentDate.HasValue ? Model.PaymentDate.Value.ToString("dd/MM/yyyy HH:mm:ss") : "Chưa thanh toán")
                </dd>

                <dt class="col-sm-3">Tên khách hàng</dt>
                <dd class="col-sm-9">
                    @if (Model.ApplicationUser != null)
                    {
                        <strong>@(Model.ApplicationUser.FullName ?? Model.ApplicationUser.UserName)</strong>
                        <a href="mailto:@Model.ApplicationUser.Email" title="Gửi Email">(@Model.ApplicationUser.Email)</a> @* Đã Sửa *@
                    }
                    else
                    {
                        <strong>@Model.CustomerName</strong>
                        <a href="mailto:@Model.CustomerEmail" title="Gửi Email">(@Model.CustomerEmail)</a> @* Đã Sửa *@
                    }
                </dd>

                <dt class="col-sm-3">Tổng cộng</dt>
                <dd class="col-sm-9 text-danger fw-bold">@totalAmount.ToString("N0") ₫</dd>
            </dl>
        </div>
    </div>

    @* ==================== DANH SÁCH SẢN PHẨM ==================== *@
    <h4 class="mb-3"><i class="bi bi-box-seam"></i> Danh sách Sản phẩm</h4>
    <table class="table table-bordered table-striped align-middle">
        <thead class="table-secondary">
            <tr>
                <th>Sản phẩm</th>
                <th class="text-center">Giá/SP</th>
                <th class="text-center">Số lượng</th>
                <th class="text-end">Thành tiền</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Items != null)
            {
                foreach (var item in Model.Items)
                {
                    var subtotal = item.Price * item.Quantity;
                    <tr>
                        <td>
                            <strong>@item.Product?.Name</strong>
                            <br />
                            <small class="text-muted">(@item.Product?.Category?.Name)</small>
                        </td>
                        <td class="text-center">@item.Price.ToString("N0") ₫</td>
                        <td class="text-center">@item.Quantity</td>
                        <td class="text-end fw-bold">@subtotal.ToString("N0") ₫</td>
                    </tr>
                }
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" class="text-end fw-bold">TỔNG CỘNG ĐƠN HÀNG</td>
                <td class="text-end text-danger fw-bold">@totalAmount.ToString("N0") ₫</td>
            </tr>
        </tfoot>
    </table>

    @* ==================== DANH SÁCH LICENSE KEY ==================== *@
    <h4 class="mt-4">
        <i class="bi bi-key"></i> Key Bản quyền đã gán (@(Model.LicenseKeys?.Count ?? 0))
    </h4>

    @if (Model.LicenseKeys != null && Model.LicenseKeys.Any())
    {
        <ul class="list-group">
            @foreach (var key in Model.LicenseKeys)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>Sản phẩm:</strong> @key.Product?.Name <br />
                        <strong>KEY:</strong> <code class="text-danger fw-bold fs-5">@key.KeyContent</code>
                    </span>
                    <small class="text-muted text-end">
                        Ngày kích hoạt:
                        @(key.ActivatedDate.HasValue ? key.ActivatedDate.Value.ToString("dd/MM/yyyy HH:mm") : "Chưa kích hoạt")
                        <br />
                        Trạng thái: @(key.IsUsed ? "Đã Gán" : "Chưa Gán")
                    </small>
                </li>
            }
        </ul>
    }
    else
    {
        <p class="text-muted">Chưa có Key nào được gán cho đơn hàng này.</p>
    }

    <div class="mt-4">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>
    </div>

    @* ==================== FORM CẬP NHẬT TRẠNG THÁI ĐƠN HÀNG ==================== *@
    <div class="card shadow-sm mt-5">
        <div class="card-header bg-primary text-white fw-bold">
            Cập nhật trạng thái đơn hàng
        </div>
        <div class="card-body">
            <form asp-action="UpdateStatus" method="post" class="row g-3 align-items-center">
                @Html.AntiForgeryToken()
                <input type="hidden" name="OrderId" value="@Model.Id" />

                <div class="col-auto">
                    <label for="Status" class="col-form-label">Trạng thái mới:</label>
                </div>
                <div class="col-auto">
                    <select id="Status" name="Status" class="form-select" required>
                        @{
                            var validStatuses = new[] { "pending", "confirmed", "shipping", "completed", "cancelled" };
                        }
                        @foreach (var status in validStatuses)
                        {
                            if (Model.Status == status)
                            {
                                <option value="@status" selected>
                                    @(char.ToUpper(status[0]) + status.Substring(1))
                                </option>
                            }
                            else
                            {
                                <option value="@status">
                                    @(char.ToUpper(status[0]) + status.Substring(1))
                                </option>
                            }
                        }

                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-repeat"></i> Cập nhật trạng thái
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>