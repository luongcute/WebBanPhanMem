@model WebBanPhanMem.Areas.Admin.Models.DashboardViewModel
@using System.Text.Json
@using System.Linq

@{
    ViewData["Title"] = "Bảng điều khiển quản trị";

    // Chuyển dữ liệu biểu đồ sang JSON (kèm kiểm tra null)
    string monthsJson = Model?.RevenueMonths != null ? JsonSerializer.Serialize(Model.RevenueMonths) : "[]";
    string totalsJson = Model?.RevenueValues != null ? JsonSerializer.Serialize(Model.RevenueValues) : "[]";
}

<div class="container mt-4">
    <h2 class="mb-4 text-center text-primary fw-bold">
        <i class="bi bi-speedometer2"></i> Bảng điều khiển quản trị
    </h2>

    <!-- Hàng 1: KPIs -->
    <div class="row text-center g-3 mb-4">

        <div class="col-md">
            <a asp-area="Admin" asp-controller="Products" asp-action="Index" class="text-decoration-none d-block">
                <div class="dashboard-card border-start border-primary border-4 hover-shadow">
                    <i class="bi bi-box-seam text-primary"></i>
                    <h5 class="mt-2 text-primary">Sản phẩm</h5>
                    <h3 class="text-dark">@(Model?.TotalProducts ?? 0)</h3>
                </div>
            </a>
        </div>

        <div class="col-md">
            <a asp-area="Admin" asp-controller="Orders" asp-action="Index" class="text-decoration-none d-block">
                <div class="dashboard-card border-start border-success border-4 hover-shadow">
                    <i class="bi bi-bag-check text-success"></i>
                    <h5 class="mt-2 text-success">Đơn hàng</h5>
                    <h3 class="text-dark">@(Model?.TotalOrders ?? 0)</h3>
                </div>
            </a>
        </div>

        <div class="col-md">
            <a asp-area="Admin" asp-controller="Users" asp-action="Index" class="text-decoration-none d-block">
                <div class="dashboard-card border-start border-warning border-4 hover-shadow">
                    <i class="bi bi-people text-warning"></i>
                    <h5 class="mt-2 text-warning">Người dùng</h5>
                    <h3 class="text-dark">@(Model?.TotalUsers ?? 0)</h3>
                </div>
            </a>
        </div>

        <div class="col-md">
            <a asp-area="Admin" asp-controller="Reports" asp-action="Index" class="text-decoration-none d-block">
                <div class="dashboard-card border-start border-danger border-4 hover-shadow">
                    <i class="bi bi-currency-exchange text-danger"></i>
                    <h5 class="mt-2 text-danger">Doanh thu</h5>
                    <h3 class="text-dark">@((Model?.TotalRevenue ?? 0).ToString("N0")) ₫</h3>
                </div>
            </a>
        </div>

        <div class="col-md">
            <a asp-area="Admin" asp-controller="Reports" asp-action="Index" class="text-decoration-none d-block">
                <div class="dashboard-card border-start border-info border-4 hover-shadow">
                    <i class="bi bi-graph-up text-info"></i>
                    <h5 class="mt-2 text-info">Báo cáo</h5>
                    <h3 class="text-dark">Chi tiết</h3>
                </div>
            </a>
        </div>
    </div>

    <!-- Hàng 2: License Keys -->
    <div class="row text-center g-3 mb-4">
        <div class="col-md-6">
            <div class="dashboard-card border-start border-info border-4 hover-shadow">
                <i class="bi bi-key text-info"></i>
                <h5 class="mt-2 text-info">Tổng số License Keys</h5>
                <h3 class="text-dark">@(Model?.TotalLicenseKeys ?? 0)</h3>
            </div>
        </div>

        <div class="col-md-6">
            <div class="dashboard-card border-start border-secondary border-4 hover-shadow">
                <i class="bi bi-check-circle text-secondary"></i>
                <h5 class="mt-2 text-secondary">Keys đã sử dụng</h5>
                <h3 class="text-dark">@(Model?.UsedLicenseKeys ?? 0)</h3>
            </div>
        </div>
    </div>

    <!-- Biểu đồ doanh thu -->
    <div class="mt-5">
        <h4 class="mb-3"><i class="bi bi-bar-chart"></i> Doanh thu 6 tháng gần nhất</h4>
        <div style="height: 300px;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Hàng 3: Bảng Top Sản phẩm & Đơn gần đây -->
    <div class="row mt-5 g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-star-fill"></i> Top 5 Sản phẩm bán chạy
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-end">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.TopProducts != null)
                            {
                                @foreach (var item in Model.TopProducts)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td class="text-center">@item.QuantitySold</td>
                                        <td class="text-end">@item.Revenue.ToString("N0") ₫</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                    @if (Model?.TopProducts == null || !Model.TopProducts.Any())
                    {
                        <p class="text-muted text-center">Chưa có dữ liệu bán hàng.</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="bi bi-receipt"></i> 5 Đơn hàng gần đây
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th class="text-end">Tổng tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.RecentOrders != null)
                            {
                                @foreach (var item in Model.RecentOrders)
                                {
                                    <tr>
                                        <td>#@item.OrderId</td>
                                        <td>@item.CustomerName</td>
                                        <td>@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td class="text-end">@item.TotalAmount.ToString("N0") ₫</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                    @if (Model?.RecentOrders == null || !Model.RecentOrders.Any())
                    {
                        <p class="text-muted text-center">Chưa có đơn hàng nào.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const labels = JSON.parse('@Html.Raw(monthsJson)');
        const data = JSON.parse('@Html.Raw(totalsJson)');

        new Chart(document.getElementById('revenueChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu (₫)',
                    data: data,
                    backgroundColor: 'rgba(13, 110, 253, 0.6)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    </script>
}

<style>
    .dashboard-card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .hover-shadow:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
</style>
